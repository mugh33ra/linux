name: Browser Terminal via Ngrok

on: [push, workflow_dispatch]

jobs:
  terminal:
    runs-on: ubuntu-latest

    steps:
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y wget unzip git build-essential cmake libjson-c-dev libwebsockets-dev

    - name: Download and Build ttyd
      run: |
        git clone https://github.com/tsl0922/ttyd.git
        cd ttyd
        mkdir build && cd build
        cmake ..
        make -j$(nproc)
        sudo make install

    - name: Download Ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip

    - name: Authenticate Ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Start ttyd and Ngrok
      run: |
        nohup ttyd -p 7681 bash &
        nohup ./ngrok http 7681 &
        sleep 5
        curl -s localhost:4040/api/tunnels > tunnels.json
        cat tunnels.json
