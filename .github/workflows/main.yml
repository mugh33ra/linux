name: Kali/Ubuntu RDP via Ngrok

on: [push, workflow_dispatch]

jobs:
  setup-rdp:
    runs-on: ubuntu-latest

    steps:
    - name: Install Desktop + RDP
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies xrdp jq

    - name: Set RDP Password
      run: echo "runner:P@ssw0rd!" | sudo chpasswd

    - name: Set Desktop Environment
      run: echo "startxfce4" | sudo tee -a /etc/skel/.xsession

    - name: Enable & Start xRDP
      run: |
        sudo systemctl enable xrdp
        sudo systemctl start xrdp

    - name: Download and Setup Ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Start Ngrok Tunnel (RDP Port 3389)
      run: |
        nohup ./ngrok tcp 3389 > ngrok.log 2>&1 &
        sleep 5
        curl -s http://127.0.0.1:4040/api/tunnels > tunnels.json
        cat tunnels.json

    - name: Extract RDP Address
      run: |
        addr=$(jq -r '.tunnels[0].public_url' < tunnels.json)
        echo "===================================="
        echo "âœ… Connect using: $addr"
        echo "ðŸ§‘â€ðŸ’» Username: runner"
        echo "ðŸ” Password: P@ssw0rd!"
        echo "===================================="

    - name: Keep Runner Alive for RDP Session
      run: |
        echo "ðŸ• Workflow is now holding to keep RDP alive..."
        tail -f /dev/null
