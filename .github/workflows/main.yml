name: Kali/Ubuntu RDP Setup via Ngrok

on: [push, workflow_dispatch]

jobs:
  setup-rdp:
    runs-on: ubuntu-latest

    steps:
    - name: Install XFCE & xRDP
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies xrdp
        sudo systemctl enable xrdp
        sudo systemctl start xrdp

    - name: Set RDP Password
      run: echo "runner:P@ssw0rd!" | sudo chpasswd

    - name: Configure xRDP to use XFCE
      run: echo "startxfce4" | sudo tee -a /etc/skel/.xsession

    - name: Download and Start Ngrok Tunnel (TCP 3389)
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        nohup ./ngrok tcp 3389 & sleep 5
        curl -s localhost:4040/api/tunnels > ngrok_tunnels.json
        cat ngrok_tunnels.json

    - name: Show Ngrok RDP URL
      run: |
        addr=$(cat ngrok_tunnels.json | jq -r '.tunnels[0].public_url')
        echo "ðŸ”— RDP URL: $addr"
