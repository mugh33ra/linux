name: SSH Access via Ngrok

on: [push, workflow_dispatch]

jobs:
  ssh-access:
    runs-on: ubuntu-latest

    steps:
    - name: Install Dependencies
      run: sudo apt update && sudo apt install -y wget unzip openssh-server jq

    - name: Download and Extract Ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip

    - name: Authenticate Ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Start SSH Service
      run: |
        sudo systemctl start ssh
        sudo systemctl enable ssh

    - name: Set Password for runner user
      run: echo "runner@P@ssw0rd!" | sudo chpasswd

    - name: Allow SSH Password Login
      run: |
        sudo sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/^#\?UsePAM .*/UsePAM yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Start Ngrok Tunnel for SSH
      run: |
        nohup ./ngrok tcp 22 > ngrok.log 2>&1 &
        sleep 6
        curl -s http://localhost:4040/api/tunnels > tunnels.json
        address=$(jq -r '.tunnels[0].public_url' < tunnels.json | sed 's#tcp://##')
        host=$(echo "$address" | cut -d: -f1)
        port=$(echo "$address" | cut -d: -f2)
        echo ""
        echo "==================== SSH Command ===================="
        echo "ssh runner@$host -p $port"
        echo "Password: P@ssw0rd!"
        echo "====================================================="
        echo ""
        echo "::set-output name=ssh_command::ssh runner@$host -p $port"

    - name: Keep Runner Alive
      run: tail -f /dev/null
